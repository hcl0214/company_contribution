# company_contribution
计算厂区LPDM贡献

# 算法结构
算法脚本包含：    
run.py   
Parse_KML.py    
algorithm.py     
PNPoly.py     
针对每个范围内点位，判断其是否在所选用的厂区内。其中主要使用Parse_KML.py读取KML文件中厂区经纬度信息，
PNPoly.py脚本进行点位是否在多边形内部的判断，algorithm.py脚本进行预处理、后处理与计算脚本的调用，
run.py作为总调用脚本，可在实际使用中加以设置传参等。各个脚本均可在合适输入参数下独立运行，以便后续使用过程中跳过或简化步骤提升效率，或是进行部分数据的io格式修改。  

# 分步介绍
## 1、生成测试用txt（使用真实数据时跳过此步）
因0.001分辨率下溯源将是百万级格点数据，生成的txt将有100MB以上，因此，此处使用make_test_txt.py脚本生成400万个格点数据，为保证数据覆盖厂区经纬度，
可修改其内部经纬度选取参数，运行脚本后，将生成将生成lat lon cdump三列构成的txt，其中cdump为随机数，为模拟同一经纬度上多个值累加情况，生成的随机数列为100万格点数据复制3次的结果。

## 2、解析KML数据
从KML文件中解析出各厂区经纬度信息，并转化为[{'name': company_name, 'lon': lon_list, 'lat': lat_list}]格式。（实际使用中，若不修改厂区KML文件，可将此步简化将输出结果保存）

## 3、预处理
1、转化厂区经纬度信息为算法输入格式
2、读取溯源txt文件（此处为test.txt），对每个厂区，仅取用在厂区经纬度外包矩形内的格点进行判断。

## 4、循环判断
针对一个厂区，将预处理后的经纬度信息与格点输入PNPoly算法程序，判断其中各点位是否满足在KML文件所划定的多边形内部。

## 5、后处理
将各厂区满足在其内部的格点值相加，并转为需求的输出格式。

# PNPoly算法介绍
原理：对于平面上一点，若其在多边形内部，则其引出的射线与多边形边相交次数为奇数次，若在外部，则与多边形边相交偶数次。

因任一射线均可作为判定标准，所以，从每个格点做水平射线进行判定。

由于射线与边的相交判定较为复杂，因而选用水平直线与多边形边交点，并挑选交点横坐标均大于（或小于）初始格点的交点数量作为相交次数。

最终的算法为，初始输出为False，对所有边循环判断，判定两点是否在格点上下两侧，如果不是，则没有交点，不改变输出；若两点在格点上下两侧，则判断其与水平直线交点位置，如果在初始格点右侧（或左侧）则视为相交，对输出结果取反。否则为不相交，不改变输出。最终输出的bool值即为格点是否在多边形内部的判断结果。

# 缺陷与改进点
1、PNPoly算法本身对于穿过边的顶点的射线不视作相交（或者理解为相交两次），否则会多边形外点位的误判，不过也导致了位于多边形格点水平线上的所有点均不被视作多边形内部。但以目前来看，KML文件的经纬度精度远大于0.001，很难出现刚好纬度与格点一致的厂区。
2、PNPoly算法需求的多边形点必须为顺次，但对于非凸多边形，点位的（凹包），同一组点可以组成多种凹包，无法通过排序手段进行判断整理，不过目前来看KML文件中存储的经纬度本身应为顺次点位，可以暂时投入使用。
